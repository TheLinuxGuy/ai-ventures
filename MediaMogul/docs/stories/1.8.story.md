# Story: User Authentication System

# Story: Simple Single-User Authentication

## Story

As a system administrator,
I want simple, secure access control for my personal MediaMogul instance,
so that only I can access my media management system with minimal setup complexity.

## Acceptance Criteria

### Authentication Foundation
- [ ] Simple JWT token-based authentication for single user
- [ ] Login page with username/password authentication
- [ ] Protected API routes require valid JWT tokens  
- [ ] Session management with reasonable token expiration
- [ ] Logout functionality clears authentication tokens
- [ ] Default credentials (admin/admin) on first startup
- [ ] Forced password change on first login with default credentials

### Security Implementation
- [ ] Password hashing using bcrypt with proper salt
- [ ] JWT tokens with reasonable expiration (4-hour sessions)
- [ ] Protected routes redirect unauthenticated users to login
- [ ] Authentication state persists across browser sessions
- [ ] Secure credential storage in existing configuration database
- [ ] Basic rate limiting on login attempts (prevent brute force)

### User Experience
- [ ] Clean, responsive login interface using existing UI components
- [ ] Authentication status visible in application header
- [ ] Seamless experience for authenticated users
- [ ] Clear feedback for authentication failures and password requirements
- [ ] Simple first-run password setup workflow

## Dev Notes

### Previous Story Insights
**From Story 1.1 - Application Bootstrap and Configuration:**
- Configuration system established with SQLite database
- Web interface accessible at http://localhost:8080
- Basic error handling patterns established

**From Story 1.7 - Basic Error Handling and Logging:**
- Comprehensive logging framework available for authentication events
- Error handling middleware patterns established
- User-friendly error message system in place

### Security Architecture Specifications
**Simplified Single-User Design:**
- Single user credentials stored in database configuration table (like ScanConfiguration)
- Default username: `admin`, default password: `admin` 
- Password must be changed on first login with default credentials
- bcrypt password hashing with cost factor 12
- JWT tokens with 4-hour expiration (no refresh tokens needed for single user)
- Session invalidated on logout or token expiration

**JWT Implementation Details:**
- Access tokens: 4-hour expiration (balance of security and usability)
- Token signing using HS256 (symmetric key for simplicity)
- Token payload includes: username: "admin", exp, iat, is_default_password: boolean

**Database Model (extends existing configuration pattern):**
```go
// AuthConfiguration represents the single user authentication settings
type AuthConfiguration struct {
    ID               int       `json:"id" gorm:"primaryKey"` // Singleton: always ID=1
    Username         string    `json:"username" gorm:"not null;default:'admin'"`
    PasswordHash     string    `json:"password_hash" gorm:"not null"`
    IsDefaultPassword bool     `json:"is_default_password" gorm:"default:true"`
    LastLogin        *time.Time `json:"last_login"`
    CreatedAt        time.Time `json:"created_at"`
    UpdatedAt        time.Time `json:"updated_at"`
}
```

### API Specifications
**Simplified Authentication Endpoints:**
- `POST /api/v1/auth/login` - User login with username/password
- `POST /api/v1/auth/logout` - User logout (client-side token removal)
- `POST /api/v1/auth/change-password` - Change password (requires current password)
- `GET /api/v1/auth/status` - Get authentication status and default password flag

**Protected Route Middleware:**
- All `/api/v1/*` routes except `/auth/*` require authentication
- Middleware validates JWT token on each request  
- Invalid/expired tokens return 401 Unauthorized
- Frontend redirects to login on 401 responses

### Component Specifications
**Frontend Authentication Components:**
- `LoginForm` component using existing UI components (Tailwind CSS)
- `AuthGuard` component for protecting routes
- `UserMenu` component in header showing authentication status  
- `PasswordChangeForm` component for first-run setup and password changes

**State Management (Simple useState/useContext):**
```typescript
interface AuthState {
  isAuthenticated: boolean;
  isDefaultPassword: boolean;
  isLoading: boolean;
  login: (username: string, password: string) => Promise<void>;
  logout: () => void;
  changePassword: (currentPassword: string, newPassword: string) => Promise<void>;
}
```

### File Locations
**Backend Implementation:**
- `apps/backend/internal/models/models.go` - Add AuthConfiguration model to existing file
- `apps/backend/internal/service/auth.go` - Authentication service (JWT generation, validation)
- `apps/backend/internal/handlers/auth.go` - HTTP handlers for authentication endpoints  
- `apps/backend/internal/middleware/auth.go` - HTTP middleware for protected routes

**Frontend Implementation:**
- `apps/frontend/app/login/page.tsx` - Login page component
- `apps/frontend/components/auth/` - Authentication-related components
  - `auth/LoginForm.tsx` - Login form component
  - `auth/PasswordChangeForm.tsx` - Password change component
  - `auth/AuthGuard.tsx` - Route protection component
  - `auth/UserMenu.tsx` - User menu in header
- `apps/frontend/lib/auth.ts` - Authentication utilities and API calls
- `apps/frontend/contexts/AuthContext.tsx` - Authentication context provider

### Integration Requirements
**Database Integration:**
- Add AuthConfiguration model to existing models.go file
- Use singleton pattern (ID=1) like ScanConfiguration
- Automatic initialization with default admin/admin credentials
- Password change updates IsDefaultPassword flag to false

**Frontend Integration:**  
- Authentication state managed with React Context (simpler than Zustand for single user)
- Protected routes use client-side AuthGuard component
- API client service updated to include JWT token in headers
- Automatic logout and redirect on 401 responses

**Security Integration:**
- JWT secret from environment variables (default generated on startup)
- Secure token storage in localStorage (acceptable for single-user desktop app)
- Rate limiting using simple in-memory counter (restart clears attempts)

### Testing Requirements
**Backend Testing:**
- Unit tests for authentication service (JWT generation/validation)
- Integration tests for authentication endpoints
- Middleware testing with valid/invalid tokens
- Password hashing and validation testing

**Frontend Testing:**
- Login form component testing with Jest/RTL  
- Authentication context testing
- Protected route testing with mock authentication
- Password change workflow testing

### Performance Considerations  
**Single-User Optimizations:**
- Simple token validation (no database lookup needed)
- Minimal session state (just authentication status)
- No background cleanup services needed
- Fast startup with default credentials ready

**User Experience:**
- Remember authentication across browser tabs
- Clear session on browser close (security vs convenience balance)
- Immediate feedback on authentication attempts
- Simple password strength requirements (8+ characters)

## Technical Tasks

### Backend Implementation
- [ ] Add AuthConfiguration model to existing models.go file
- [ ] Implement JWT authentication service with HS256 signing
- [ ] Create authentication middleware for route protection
- [ ] Build authentication HTTP handlers (login, logout, change-password, status)
- [ ] Add authentication routes to Gin router
- [ ] Implement automatic default credential initialization
- [ ] Add basic rate limiting for login attempts

### Frontend Implementation
- [ ] Create login page with form validation
- [ ] Build authentication components (LoginForm, PasswordChangeForm, AuthGuard, UserMenu)  
- [ ] Implement authentication React context
- [ ] Add authentication API client methods
- [ ] Integrate route protection with AuthGuard component
- [ ] Update application header to show authentication status
- [ ] Add logout functionality and forced password change flow

### Integration & Testing
- [ ] Initialize AuthConfiguration with default credentials on app startup
- [ ] Configure JWT secrets via environment variables (with fallback generation)
- [ ] Add comprehensive authentication tests (backend and frontend)
- [ ] Add authentication to existing protected routes
- [ ] Test first-run password change workflow end-to-end

### Security Hardening
- [ ] Implement basic rate limiting on login endpoint (memory-based)
- [ ] Add password strength validation (8+ characters, mixed case recommended)
- [ ] Configure secure JWT token handling
- [ ] Add proper error messages without information disclosure

## Definition of Done

- [ ] User must authenticate with username/password to access MediaMogul application
- [ ] All API endpoints except authentication are properly protected
- [ ] Default admin/admin credentials work on fresh installation
- [ ] User is forced to change password on first login with default credentials
- [ ] Authentication state persists across browser sessions until logout
- [ ] JWT token-based security with reasonable 4-hour expiration
- [ ] Login/logout flow works seamlessly with good user experience
- [ ] Password change functionality works correctly
- [ ] All authentication components integrate with existing MediaMogul design
- [ ] Basic protection against brute force login attempts
- [ ] Secure password storage using bcrypt hashing
- [ ] Comprehensive tests validate authentication security and functionality
- [ ] Simple, maintenance-free single-user authentication suitable for personal use

## QA Results

*To be completed by QA Review*

## Dev Agent Record

*To be completed by Dev Agent during implementation*
