# Story: Power-Efficient Operation Framework

## Story

As a user,
I want MediaMogul to respect disk power management,
so that sleeping disks remain asleep unless I explicitly need them accessed.

## Acceptance Criteria

### Integration Testing
- [ ] Test power-aware operation workflows end-to-end
  - [ ] Verify user confirmation flows for potentially disruptive operations
  - [ ] Test opportunistic operations during high activity periods
  - [ ] Validate disk activity detection accuracy across different hardware
  - [ ] Test /proc/diskstats parsing with various device configurations
- [ ] Test configuration management and policy enforcement
  - [ ] Verify power settings load correctly from config
  - [ ] Test configuration hot-reloading functionality
  - [ ] Validate secure defaults and configuration validation
- [ ] Performance testing for monitoring overhead
  - [ ] Measure CPU/memory impact of disk activity monitoring
  - [ ] Verify polling intervals don't impact system responsiveness
  - [ ] Test scalability with multiple disks and partitions

### Backend Implementation - Disk Activity Monitoring
- [ ] Implement /proc/diskstats monitoring service (AC: 7)
  - [ ] Parse /proc/diskstats entries for read/write operation counts
  - [ ] Track partition-level activity for kernels 5.4+ support
  - [ ] Implement device symlink resolution for proper device identification
  - [ ] Create activity detection with configurable thresholds
  - [ ] Implement efficient polling with minimal system impact
- [ ] Create DiskActivity model and service (AC: 7)
  - [ ] Implement DiskActivity struct with partition-level granularity
  - [ ] Add database operations for activity tracking
  - [ ] Create service methods for querying recent activity
  - [ ] Implement activity caching to reduce database overhead
- [ ] Implement disk activity API endpoints (AC: 7)
  - [ ] POST /api/disk-activity for activity updates
  - [ ] GET /api/disks/{id}/activity for activity status queries
  - [ ] Include activity indicators in disk status responses
- [ ] Write comprehensive tests for disk activity monitoring
  - [ ] Unit tests for /proc/diskstats parsing
  - [ ] Integration tests for activity detection
  - [ ] Mock tests for different kernel versions and device configurations## Dev Notes

### Previous Story Insights
**From Story 1.1 - Application Bootstrap and Configuration:**
- Configuration system for user preferences and disk monitoring settings
- PhysicalDisk model with monitoring enable/disable capability

**From Story 1.2 - Physical Disk Discovery and Registration:**
- Power status detection using smartctl (active/standby/sleep)
- Disk power status caching and periodic updates
- Graceful handling of unavailable disks

**From Story 1.3 - File System Scanning Engine:**
- Database contains complete file inventory for offline browsing
- Power status checking before disk access during scans
- Scan operations respect sleeping disk status

**From Story 1.4 - System Dashboard:**
- Real-time power status display in dashboard components
- Status indicators for disk power states

**From Story 1.5 - File Browser Interface:**
- Database-driven file browsing without requiring disk access
- Complete file metadata available offline

### Data Models
**Power Management Configuration** [Uses existing Story 1.1 config system]
- Power preferences stored in application configuration (config.yaml/JSON)
- No new database tables required - leverages existing configuration infrastructure
- Settings: auto_wake_disks, opportunistic_operations, confirmation_required, wake_timeout_seconds
- Default values: secure defaults (no auto-wake, require confirmation)

**DiskOperation Model** [Source: Epic 1 Technical Tasks]
- Purpose: Track operations that require disk access (runtime only)
- Key Attributes:
  - `operation_type TEXT NOT NULL` - Type of operation (scan, read, write)
  - `disk_id TEXT NOT NULL` - Target disk identifier
  - `requires_wake BOOLEAN` - Whether operation needs disk to be active
  - `user_confirmed BOOLEAN DEFAULT false` - User approval status
- No persistent table - runtime operation tracking using in-memory structures

**DiskActivity Model** [New for `/proc/diskstats` monitoring]
- Purpose: Monitor disk activity without waking sleeping disks (following hd-idle patterns)
- Key Attributes:
  - `device_name TEXT` - Device name (e.g., sda, sda1 for partitions)
  - `reads_completed INTEGER` - Total reads completed
  - `writes_completed INTEGER` - Total writes completed
  - `sectors_read INTEGER` - Total sectors read
  - `sectors_written INTEGER` - Total sectors written
  - `last_activity_time INTEGER` - Unix nanosecond timestamp of last activity detection
- Data Source: Parsed from `/proc/diskstats` at partition/device mapper level
- Monitoring Strategy: Track partition-level changes to avoid false positives from monitoring tools

### API Specifications
**Power Management API Endpoints** [Source: Epic 1 Technical Tasks]
- GET /api/v1/power/config - Get current power management settings from application config
- POST /api/v1/power/config - Update power management configuration settings
- POST /api/v1/power/wake/{disk_id} - Wake specific disk with user confirmation
- GET /api/v1/power/status - Get power status for all disks (uses existing PhysicalDisk.power_status)
- GET /api/v1/power/activity/{disk_id} - Get disk activity statistics from `/proc/diskstats`
- POST /api/v1/power/operations/confirm - Confirm disk-waking operations

### Component Specifications
**Power Management UI Components** [Source: Epic 1 Technical Tasks]
- Power policy configuration page with preference settings
- Disk operation confirmation dialogs before waking sleeping disks
- Power status indicators throughout the application
- Opportunistic operation notifications when disks become active
- React components with Tailwind CSS styling [Source: architecture.md#Tech Stack]

### File Locations
**Backend Structure** [Source: architecture.md#Unified Project Structure]
- Power management service: `apps/backend/internal/service/powermgmt.go`
- Operation tracking: `apps/backend/internal/service/operations.go`  
- Disk activity monitoring: `apps/backend/internal/service/diskactivity.go`
- `/proc/diskstats` parser: `apps/backend/internal/service/diskstats.go`
- Configuration integration: Uses existing config service from Story 1.1
- Power API endpoints: `apps/backend/internal/api/power.go`

**Frontend Structure** [Source: architecture.md#Unified Project Structure]
- Power settings page: `apps/frontend/app/settings/power/page.tsx`
- Confirmation dialogs: `apps/frontend/components/power/`
- Power hooks: `apps/frontend/hooks/usePowerManagement.ts`
- Shared types: `packages/shared-types/power.ts`

### Technical Constraints
**NFR1 Compliance**: Never wake sleeping disks without user consent [Source: architecture.md NFR1]
**Performance**: Power status checks must be fast and cached
**User Experience**: Clear indicators for operations requiring disk access
**System Integration**: Integration with existing smartctl power detection
**Configuration**: User-configurable power policies and preferences
**Disk Activity Monitoring**: `/proc/diskstats` parsing without waking sleeping disks
**Partition-Level Detection**: Monitor partition/device mapper activity (hd-idle approach)
**Kernel Compatibility**: Support for kernels 5.4+ with partition-level monitoring strategy

### Testing Requirements
**Backend Testing**: Unit tests for power policy enforcement and operation tracking [Source: architecture.md#Tech Stack]
**Frontend Testing**: Component tests for confirmation dialogs and power indicators
**Integration Testing**: End-to-end power management workflows
**Compliance Testing**: Verify sleeping disks are never awakened without consent

## Tasks / Subtasks

### Backend Implementation - Disk Activity Monitoring System
- [ ] Create `/proc/diskstats` parser service (AC: 7, 8)
  - [ ] Parse disk statistics from `/proc/diskstats` without waking sleeping disks
  - [ ] Implement partition-level activity detection (following hd-idle design patterns)
  - [ ] Support both disk-level and partition-level monitoring strategies
  - [ ] Handle device mapper and LUKS encrypted disk detection
- [ ] Implement disk activity tracking service (AC: 7, 8)
  - [ ] Monitor read/write activity changes at partition level for kernels 5.4+
  - [ ] Detect actual disk activity vs. monitoring tool false positives
  - [ ] Track last activity timestamps with nanosecond precision
  - [ ] Provide activity status without physical disk access
- [ ] Add device symlink resolution (following hd-idle patterns)
  - [ ] Resolve `/dev/disk/by-id/*` symlinks to actual device names
  - [ ] Support runtime symlink resolution for hot-plugged devices
  - [ ] Handle device mapper and encrypted partition detection
- [ ] Write unit tests for `/proc/diskstats` parsing and activity detection
### Backend Implementation - Power Configuration System
- [ ] Enhance configuration service to include power management settings (AC: 6)
  - [ ] Add power management section to config.yaml structure
  - [ ] Add fields for auto-wake, opportunistic operations, confirmation settings
  - [ ] Add disk activity monitoring configuration (polling intervals, detection thresholds)
  - [ ] Implement config validation with secure defaults
- [ ] Implement power configuration service (AC: 6)
  - [ ] Load and cache power management preferences from config
  - [ ] Provide policy enforcement logic for operations
  - [ ] Handle config updates and hot-reloading
- [ ] Write unit tests for power configuration management

### Backend Implementation - Operation Framework
- [ ] Create operation tracking service (AC: 1, 3)
  - [ ] Track operations that require disk access
  - [ ] Check disk power status before operations
- [ ] Implement user confirmation system (AC: 4)
  - [ ] Queue operations requiring sleeping disk access
  - [ ] Track user approval status for disk-waking operations
- [ ] Add opportunistic operation detection (AC: 5)
  - [ ] Monitor disk power status changes
  - [ ] Execute queued operations when disks become active
- [ ] Integrate with existing disk power status from Story 1.2 (PhysicalDisk.power_status)
- [ ] Write unit tests for operation framework and confirmation logic

### Backend Implementation - Power Management API
- [ ] Create GET /api/v1/power/config endpoint  
  - [ ] Return current power management configuration from config service
  - [ ] Include all power management preference settings
- [ ] Create POST /api/v1/power/config endpoint
  - [ ] Accept power configuration updates from user
  - [ ] Validate and save configuration changes
- [ ] Create POST /api/v1/power/wake/{disk_id} endpoint
  - [ ] Handle user-initiated disk wake requests
  - [ ] Require explicit user confirmation
- [ ] Create POST /api/v1/power/operations/confirm endpoint
  - [ ] Process user confirmations for queued operations  
  - [ ] Execute approved disk-waking operations
- [ ] Add proper error handling and configuration enforcement
- [ ] Write unit tests for all power management API endpoints

### Frontend Implementation - Power Configuration
- [ ] Create power configuration page (AC: 6)
  - [ ] Settings for auto-wake behavior and confirmation requirements
  - [ ] Opportunistic operation preferences
  - [ ] Clear explanations of each power management option
  - [ ] Integration with existing configuration system from Story 1.1
- [ ] Implement power status indicators throughout UI (AC: 3)
  - [ ] Visual indicators for disk power states in all relevant components
  - [ ] Update dashboard, browser, and scan components with power indicators
- [ ] Add operation confirmation dialogs (AC: 4)
  - [ ] Modal dialogs requesting user approval for disk-waking operations
  - [ ] Clear explanation of which disks will be awakened and why
- [ ] Create opportunistic operation notifications (AC: 5)
  - [ ] Notifications when operations can proceed due to active disks
  - [ ] Queue status indicators for pending operations
- [ ] Style all components with Tailwind CSS

### Integration with Existing Stories
- [ ] Update scan service from Story 1.3 (AC: 1, 2)
  - [ ] Integrate power status checking before file system access
  - [ ] Use database-only scanning for sleeping disks
- [ ] Update file browser from Story 1.5 (AC: 2)
  - [ ] Ensure browsing uses database only, never requires disk access
  - [ ] Add power status indicators to file browser interface
- [ ] Update dashboard from Story 1.4 (AC: 3)
  - [ ] Include power management status and policy information
  - [ ] Show queued operations waiting for user confirmation
- [ ] Integrate with disk discovery from Story 1.2
  - [ ] Use existing power status detection infrastructure
  - [ ] Enhance power status monitoring with policy enforcement

### Integration & Quality
- [ ] Test complete power management workflow from configuration to execution
- [ ] Verify sleeping disks are never awakened without explicit user consent
- [ ] Test opportunistic operations execute correctly when disks become active
- [ ] Validate database-driven browsing works without any disk access
- [ ] Test user confirmation dialogs and operation queuing
- [ ] Verify power configuration persists and applies correctly (via config system)
- [ ] Test error scenarios (power detection failure, disk wake timeout)
- [ ] Validate integration with all existing stories maintains power efficiency

## Definition of Done

- Sleeping disks never awakened without explicit user consent (NFR1 compliance)
- Clear indicators show when operations require disk access throughout the UI
- Database provides complete browsing and planning without requiring disk access
- User can configure power-efficiency behavior according to their preferences
- Opportunistic operations work correctly when disks are already active
- User confirmation system prevents accidental disk wake operations
- All tests pass (unit, integration, component, compliance)
- No violations of power management policies during any application operations

## File List

- `apps/backend/internal/service/powermgmt.go` - Power management service (267 lines)
- `apps/backend/internal/handlers/power.go` - Power API endpoints (164 lines)
- `apps/frontend/app/settings/power/page.tsx` - Power settings UI (287 lines)
- Navigation integration in settings layout completed

## Dev Agent Record

### Implementation Notes
*To be populated during development*

### Completion Notes
*To be populated upon completion*

### Debug Log References
*To be populated if debugging required*

## QA Results

*To be populated during QA review*
