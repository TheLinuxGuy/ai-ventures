# Story 4.1: External Services Integration Foundation

## Story

As a system administrator,
I want a robust foundation for integrating with external services,
So that MediaMogul can securely and reliably connect to third-party APIs like Sonarr and Radarr with proper authentication, health monitoring, and error handling.

## Story Context

**Epic:** 4 - External Services Integration & Advanced Management  
**Dependencies:** Epic 1-3 Complete (Foundation, Task Engine, Migration System)  
**Story Type:** Infrastructure - External Integration Foundation  

This story establishes the foundational infrastructure for all external service integrations in MediaMogul. It provides a secure, extensible framework that will support Sonarr/Radarr integrations and future third-party services with proper authentication, health monitoring, rate limiting, and error resilience.

## Acceptance Criteria

### Service Registry & Management
- [ ] **Service registration:** Centralized registry for all external service configurations
- [ ] **Service discovery:** Automatic discovery and validation of service capabilities
- [ ] **Service lifecycle:** Enable, disable, configure, and remove services dynamically
- [ ] **Service types:** Support for different service types (metadata, monitoring, storage)
- [ ] **Configuration validation:** Validate service configurations before activation
- [ ] **Service metadata:** Store service descriptions, capabilities, and requirements

### Authentication & Security
- [ ] **Credential management:** Secure storage and retrieval of API keys and tokens
- [ ] **Encryption:** Encrypt sensitive credentials using industry-standard methods
- [ ] **Authentication validation:** Test and validate authentication before service activation
- [ ] **Credential rotation:** Support for updating credentials without service interruption
- [ ] **Security audit:** Log all authentication attempts and credential changes
- [ ] **Isolation:** Ensure service credentials are isolated from other system components

### Health Monitoring & Reliability
- [ ] **Health checks:** Regular health monitoring of all active services
- [ ] **Service status:** Real-time status tracking (active, inactive, error, maintenance)
- [ ] **Uptime monitoring:** Track service availability and response times
- [ ] **Error detection:** Identify and categorize service failures and errors
- [ ] **Alerting:** Notify administrators of service health issues
- [ ] **Health history:** Maintain historical health data for trend analysis

### Circuit Breaker & Resilience
- [ ] **Circuit breaker pattern:** Automatically disable failing services to prevent cascading failures
- [ ] **Failure thresholds:** Configurable thresholds for service failure detection
- [ ] **Recovery testing:** Automatic testing for service recovery after failures
- [ ] **Graceful degradation:** Continue operation with reduced functionality when services are unavailable
- [ ] **Retry logic:** Intelligent retry mechanisms with exponential backoff
- [ ] **Timeout handling:** Proper timeout management for external API calls

### Rate Limiting & Throttling
- [ ] **API rate limiting:** Respect external service rate limits to prevent blocking
- [ ] **Request throttling:** Limit concurrent requests to external services
- [ ] **Queue management:** Queue requests when rate limits are approached
- [ ] **Priority handling:** Prioritize critical requests over background operations
- [ ] **Backoff strategies:** Implement backoff when rate limits are exceeded
- [ ] **Rate limit monitoring:** Track and report on rate limit usage

### API Client Framework
- [ ] **Standardized clients:** Common interface for all external service clients
- [ ] **Protocol abstraction:** Support for HTTP REST APIs with extensible design
- [ ] **Request/response handling:** Consistent handling of API requests and responses
- [ ] **Error standardization:** Uniform error handling and reporting across all services
- [ ] **Logging integration:** Comprehensive logging of all external API interactions
- [ ] **Metrics collection:** Collect performance and usage metrics for all API calls

## Database Schema

**External Services Tables** (`migrations/008_external_services.sql`)
```sql
CREATE TABLE external_services (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('metadata', 'monitoring', 'storage', 'automation')),
    base_url TEXT NOT NULL,
    api_key_encrypted BLOB, -- Encrypted API key
    configuration TEXT NOT NULL DEFAULT '{}', -- JSON service configuration
    status TEXT NOT NULL DEFAULT 'inactive' CHECK (status IN ('inactive', 'active', 'error', 'maintenance', 'testing')),
    health_check_url TEXT,
    last_health_check INTEGER,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    capabilities TEXT NOT NULL DEFAULT '[]', -- JSON array of ServiceCapability
    rate_limits TEXT NOT NULL DEFAULT '{}', -- JSON RateLimitConfig
    metadata TEXT NOT NULL DEFAULT '{}' -- JSON additional metadata
);

CREATE INDEX idx_external_services_type ON external_services(type);
CREATE INDEX idx_external_services_status ON external_services(status);

CREATE TABLE service_connection_tests (
    id TEXT PRIMARY KEY,
    service_id TEXT NOT NULL REFERENCES external_services(id) ON DELETE CASCADE,
    success BOOLEAN NOT NULL,
    response_time INTEGER, -- Microseconds
    error_message TEXT,
    tested_at INTEGER NOT NULL
);

CREATE TABLE service_health_history (
    id TEXT PRIMARY KEY,
    service_id TEXT NOT NULL REFERENCES external_services(id) ON DELETE CASCADE,
    status TEXT NOT NULL,
    response_time INTEGER, -- Microseconds
    error_message TEXT,
    checked_at INTEGER NOT NULL
);
```

## Validation & Testing

### Unit Tests
- [ ] Service registration and configuration validation
- [ ] Authentication and credential encryption/decryption
- [ ] Circuit breaker state transitions and recovery
- [ ] Rate limiting functionality and queue management
- [ ] Health monitoring and failure detection

### Integration Tests
- [ ] End-to-end service registration and activation
- [ ] Mock external service integration testing
- [ ] Database operations and data persistence
- [ ] API endpoint functionality and error handling
- [ ] Circuit breaker integration with real failure scenarios

### Security Tests
- [ ] Credential encryption and secure storage
- [ ] API key handling and transmission security
- [ ] Authentication mechanism validation
- [ ] Input validation and sanitization
- [ ] Rate limiting bypass prevention

## Dependencies

**Required Infrastructure:**
- Epic 1: Database and core foundation
- Epic 2: Task engine for background operations
- Epic 3: Not directly dependent, but may integrate with migration system

**Technical Dependencies:**
- Encryption library for secure credential storage
- HTTP client library with timeout and retry capabilities
- Circuit breaker pattern implementation
- Rate limiting and throttling mechanisms

## Definition of Done

- [ ] External service registry with complete CRUD operations
- [ ] Secure authentication and credential management system
- [ ] Health monitoring with automatic failure detection
- [ ] Circuit breaker pattern preventing cascade failures
- [ ] Rate limiting respecting external service constraints
- [ ] Standardized API client framework for all integrations
- [ ] Complete REST API for external service management
- [ ] Frontend interface for service configuration and monitoring
- [ ] Database schema supporting all external service operations
- [ ] Comprehensive logging and error reporting

## Success Metrics

- **Reliability:** 99.9%+ uptime for external service integration framework
- **Security:** Zero credential leaks or authentication failures
- **Performance:** <100ms overhead for external service API calls
- **Resilience:** Graceful handling of external service outages without system impact
- **Usability:** Clear service health status and easy configuration process

## Next Stories

This story enables:
- **Story 4.2:** Sonarr & Radarr Integration - Specific *arr application clients
- **Story 4.3:** Advanced File Deletion - May leverage external service framework for backup services
- **Future Stories:** Additional external service integrations (notification services, cloud storage APIs, etc.)

## PRD Requirements Fulfilled

- **Infrastructure for FR9:** Foundation for Sonarr and Radarr API integration
- **NFR2:** Reliable operation with external service dependencies
- **Security:** Secure storage and handling of external service credentials
- **Extensibility:** Framework supports future external service integrations

## Dev Notes

### Previous Story Context
**This story assumes completion of Story 1.8 (User Authentication System):**
- Authentication framework provides secure access to configuration
- User management system controls who can modify external service settings
- JWT-protected API endpoints ensure secure configuration access

**Integration with Epic 1-3 Foundation:**
- Database schema (V4) ready for external service correlation data
- File metadata system can store external service tags and identifiers
- Task system can queue external service synchronization tasks

### External Service API Analysis
**Sonarr API Capabilities:**
- Library export via `/api/v3/series` endpoint
- Episode information via `/api/v3/episode` endpoint  
- Quality profiles and monitoring status
- File path resolution via episode file data

**Radarr API Capabilities:**
- Movie library via `/api/v3/movie` endpoint
- Quality profiles and monitoring status
- File path resolution via movie file data
- Collection and metadata information

**Common Integration Patterns:**
- API key authentication via `X-Api-Key` header
- JSON response format with standardized error codes
- Rate limiting considerations (respectful API usage)
- Version compatibility handling (v1/v3 API differences)

### Database Schema Extensions (V4)
**External Service Configuration:**
```sql
-- External service configuration table
CREATE TABLE external_services (
    uid TEXT PRIMARY KEY,
    service_type TEXT NOT NULL,              -- 'sonarr' or 'radarr'
    service_name TEXT NOT NULL,              -- User-friendly name
    base_url TEXT NOT NULL,                  -- https://sonarr.example.com
    api_key_encrypted TEXT NOT NULL,        -- AES-256 encrypted API key
    is_enabled BOOLEAN DEFAULT TRUE,
    last_sync_attempt INTEGER NULL,         -- Unix nano timestamp
    last_sync_success INTEGER NULL,         -- Unix nano timestamp
    sync_status TEXT DEFAULT 'never',       -- never, success, failed, in_progress
    error_message TEXT NULL,                -- Last sync error if any
    created_on INTEGER NOT NULL,
    updated_on INTEGER NOT NULL
);

-- Path mapping configuration
CREATE TABLE service_path_mappings (
    uid TEXT PRIMARY KEY,
    service_uid TEXT NOT NULL,
    local_path TEXT NOT NULL,               -- MediaMogul path (e.g., /mnt/disk1/)
    remote_path TEXT NOT NULL,              -- Service path (e.g., /downloads/)
    is_active BOOLEAN DEFAULT TRUE,
    created_on INTEGER NOT NULL,
    FOREIGN KEY (service_uid) REFERENCES external_services(uid)
);

-- External service file correlations
CREATE TABLE external_file_tags (
    uid TEXT PRIMARY KEY,
    file_uid TEXT NOT NULL,                 -- FK to files.uid
    service_uid TEXT NOT NULL,              -- FK to external_services.uid
    external_id TEXT NOT NULL,              -- Service-specific ID
    external_type TEXT NOT NULL,            -- 'series', 'episode', 'movie'
    external_data TEXT NULL,                -- JSON metadata from service
    last_updated INTEGER NOT NULL,          -- Unix nano timestamp
    FOREIGN KEY (file_uid) REFERENCES files(uid),
    FOREIGN KEY (service_uid) REFERENCES external_services(uid)
);
```

### API Specifications
**External Service Configuration Endpoints:**
- `GET /api/v1/external-services` - List all configured services
- `POST /api/v1/external-services` - Add new service configuration
- `PUT /api/v1/external-services/{uid}` - Update service configuration
- `DELETE /api/v1/external-services/{uid}` - Remove service configuration
- `POST /api/v1/external-services/{uid}/test` - Test service connection
- `GET /api/v1/external-services/{uid}/status` - Get service health status

**Path Mapping Management:**
- `GET /api/v1/external-services/{uid}/path-mappings` - Get path mappings for service
- `POST /api/v1/external-services/{uid}/path-mappings` - Add path mapping
- `PUT /api/v1/path-mappings/{uid}` - Update specific path mapping
- `DELETE /api/v1/path-mappings/{uid}` - Remove path mapping
- `POST /api/v1/path-mappings/{uid}/test` - Test path mapping resolution

### Security Implementation
**API Key Encryption:**
- AES-256 encryption for API key storage
- Encryption key derived from application secret + service uid salt
- Decryption only occurs during API calls, never for display
- Key rotation support for future security enhancements

**Configuration Access Control:**
- External service configuration requires admin role (from Story 1.8)
- API endpoints protected by JWT authentication middleware
- Audit logging of all configuration changes
- Rate limiting on external service test connections

### Component Specifications
**Settings Page Extension:**
- `ExternalServicesSection` - Main configuration section
- `ServiceConfigCard` - Individual service configuration
- `PathMappingTable` - Path mapping management interface
- `ConnectionTestButton` - Service connection testing
- `ServiceStatusIndicator` - Real-time connection status

**Frontend State Management:**
```typescript
interface ExternalServicesState {
  services: ExternalService[];
  pathMappings: PathMapping[];
  connectionStatus: Record<string, ServiceStatus>;
  isLoading: boolean;
  testConnection: (serviceUid: string) => Promise<boolean>;
  saveService: (service: ExternalService) => Promise<void>;
  addPathMapping: (mapping: PathMapping) => Promise<void>;
  removeService: (serviceUid: string) => Promise<void>;
}
```

### File Locations
**Backend Implementation:**
- `apps/backend/internal/models/external_service.go` - External service models
- `apps/backend/internal/external/` - External service integration
  - `external/sonarr.go` - Sonarr API client and integration
  - `external/radarr.go` - Radarr API client and integration
  - `external/service.go` - Common service interface and utilities
  - `external/path_mapper.go` - Path mapping resolution service
- `apps/backend/internal/api/external_services.go` - API handlers
- `apps/backend/internal/crypto/encryption.go` - Credential encryption utilities

**Frontend Implementation:**
- `apps/frontend/app/settings/external-services/page.tsx` - External services settings page
- `apps/frontend/components/settings/` - Settings-related components
  - `settings/ExternalServicesSection.tsx` - Main configuration section
  - `settings/ServiceConfigCard.tsx` - Individual service configuration
  - `settings/PathMappingTable.tsx` - Path mapping management
  - `settings/ConnectionTestButton.tsx` - Connection testing
- `apps/frontend/stores/externalServicesStore.ts` - External services state
- `apps/frontend/lib/external-services.ts` - API client methods

### Integration Requirements
**With Authentication System (Story 1.8):**
- Configuration endpoints require admin role authentication
- Settings page access protected by authentication guard
- User session management for configuration changes

**With Database System (Epic 1):**
- External service models integrate with existing GORM setup
- Database migrations include external service tables
- Foreign key relationships to files table for correlation

**With File System (Epic 1):**
- Path mapping integrates with disk mount point detection
- File correlation uses existing file metadata structure
- Path resolution works with relative path calculations

### Error Handling & User Experience
**Connection Testing:**
- Comprehensive error messages for common failures (network, auth, API version)
- Loading states during connection tests and synchronization
- Success/failure indicators with actionable next steps
- Timeout handling for unresponsive services

**Configuration Validation:**
- URL format validation (must include protocol)
- API key format validation (service-specific patterns)
- Path mapping validation (must be absolute paths)
- Duplicate service prevention

**Graceful Degradation:**
- Application functions normally when external services unavailable
- External service features disabled gracefully with clear messaging
- No impact on core MediaMogul functionality (browsing, scanning, migration)
- Retry logic with exponential backoff for temporary failures

### Performance Considerations
**API Rate Limiting:**
- Respectful API usage patterns (no excessive polling)
- Batch requests where possible to minimize API calls
- Caching of external service data with appropriate TTL
- Background synchronization jobs rather than real-time requests

**Database Optimization:**
- Indexes on external_file_tags for efficient correlation queries
- Efficient path mapping lookups with proper indexing
- Cleanup jobs for obsolete external service data
- Connection pooling for database access

### Future Extensibility
**Service Adapter Pattern:**
- Generic external service interface for easy addition of new services
- Plugin-like architecture for service-specific implementations
- Consistent configuration patterns across all external services
- Extensible path mapping system for various service types

## Technical Tasks

### Backend Implementation
- [ ] Create external service data models with GORM relationships
- [ ] Implement AES-256 encryption service for API credentials
- [ ] Build Sonarr API client with authentication and error handling
- [ ] Build Radarr API client with authentication and error handling
- [ ] Create path mapping resolution service
- [ ] Implement external service configuration API endpoints
- [ ] Add connection testing functionality with comprehensive error reporting
- [ ] Build path mapping management API endpoints

### Frontend Implementation
- [ ] Create external services settings page with responsive design
- [ ] Build service configuration components using shadcn/ui
- [ ] Implement path mapping management interface
- [ ] Create connection testing UI with real-time feedback
- [ ] Add service status indicators and health monitoring
- [ ] Build external services Zustand store
- [ ] Implement external services API client methods
- [ ] Add form validation for service configuration inputs

### Security & Integration
- [ ] Integrate external service configuration with authentication system
- [ ] Add admin role requirements for external service management
- [ ] Implement audit logging for configuration changes
- [ ] Add rate limiting for external service API calls
- [ ] Create database migrations for external service tables
- [ ] Add comprehensive error handling and user feedback
- [ ] Implement graceful degradation when services unavailable

### Testing & Documentation
- [ ] Add unit tests for external service API clients
- [ ] Create integration tests for external service configuration
- [ ] Add frontend component tests for configuration interface
- [ ] Test path mapping resolution with various scenarios
- [ ] Create user documentation for external service setup
- [ ] Add API documentation for external service endpoints
- [ ] Test connection scenarios (success, failure, timeout)
- [ ] Validate security of credential storage and handling

## Definition of Done

- [ ] Users can configure Sonarr and Radarr connections via settings interface
- [ ] Connection testing validates API accessibility with clear error messages
- [ ] Path mapping handles different mount points correctly between services
- [ ] API credentials stored securely with AES-256 encryption
- [ ] External services work independently (failure doesn't break MediaMogul)
- [ ] Configuration changes take effect immediately without application restart
- [ ] Real-time service status indicators provide health monitoring
- [ ] Path mapping validation prevents configuration errors
- [ ] Comprehensive error handling with user-friendly messages
- [ ] All external service components integrate with existing authentication system
- [ ] Settings interface follows established shadcn/ui design patterns
- [ ] External service configuration ready for file correlation in future stories

## QA Results

*To be completed by QA Review*

## Dev Agent Record

*To be completed by Dev Agent during implementation*
