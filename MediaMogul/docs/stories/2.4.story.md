# Story: Task Management Interface

## Story

As a user,
I want a comprehensive task queue management interface,
So that I can monitor the progress of background operations, manage pending tasks, review completed work, and troubleshoot any issues with my MediaMogul system.

## Story Context

**Epic:** 2 - Asynchronous Task Engine & Data Enrichment  
**Dependencies:** Story 2.1 (Task Engine Foundation), Story 2.2 (MD5), Story 2.3 (MediaInfo)  
**Story Type:** User Interface - Task Management  

This story creates the primary user interface for the task system established in previous Epic 2 stories. It fulfills FR10's requirement for "a detailed view of the task queue, including the number of parallel tasks currently executing, the number of pending tasks, and the execution mode."

## Acceptance Criteria

### Task Queue Overview Dashboard
- [ ] **Real-time statistics:** Active, pending, completed, and failed task counts
- [ ] **Execution capacity:** Current worker utilization (e.g., "2 of 3 workers busy")
- [ ] **Performance metrics:** Tasks completed today, average execution time, success rate
- [ ] **Quick actions:** Pause all tasks, resume processing, clear completed tasks
- [ ] **System health:** Task engine status, worker pool health, error indicators

### Task List Interface
- [ ] **Comprehensive task display:** All tasks with status, type, priority, progress, timestamps
- [ ] **Real-time updates:** Task status and progress update automatically without page refresh
- [ ] **Filtering options:** Filter by status (pending/executing/complete/failed), type, priority, date range
- [ ] **Sorting capabilities:** Sort by creation time, priority, progress, duration, status
- [ ] **Pagination:** Handle large task histories efficiently (50 tasks per page default)
- [ ] **Search functionality:** Search tasks by description, file paths, error messages

### Individual Task Details
- [ ] **Task information panel:** UID, type, priority, status, description, creation/completion times
- [ ] **Progress visualization:** Progress bar with percentage, files processed, bytes processed
- [ ] **File context:** Source/destination disk information, file paths involved
- [ ] **Execution details:** Worker assignment, estimated duration, actual duration
- [ ] **Error handling:** Detailed error messages, retry information, troubleshooting hints
- [ ] **Task actions:** Cancel pending tasks, retry failed tasks, view logs

### Task Control Actions
- [ ] **Individual task actions:** Cancel, retry, delete, view details
- [ ] **Bulk operations:** Cancel multiple tasks, delete completed tasks, retry failed tasks
- [ ] **Task creation shortcuts:** Quick start MD5/MediaInfo tasks for selected files
- [ ] **Priority adjustment:** Change task priority for pending tasks
- [ ] **Dependency management:** View and modify task dependencies

### Task History & Reporting
- [ ] **Completion history:** Recently completed tasks with duration and outcome
- [ ] **Failure analysis:** Failed tasks with error categorization and retry recommendations
- [ ] **Performance trends:** Task completion rates over time, peak processing periods
- [ ] **Export functionality:** Export task history as CSV/JSON for analysis
- [ ] **Cleanup controls:** Archive old tasks, set retention policies

### Real-Time Updates & Notifications
- [ ] **WebSocket integration:** Real-time task status and progress updates
- [ ] **Visual notifications:** Toast notifications for task completion/failure
- [ ] **Sound notifications:** Optional audio alerts for completed tasks (configurable)
- [ ] **Progress animations:** Smooth progress bar updates and status transitions
- [ ] **Auto-refresh:** Configurable refresh intervals when WebSocket unavailable

## Technical Implementation

### Frontend Components

**Task Dashboard** (`app/tasks/page.tsx`)
```tsx
'use client'
export default function TaskQueuePage() {
  const { tasks, stats, isLoading } = useTaskQueue()
  const { ws } = useWebSocket('/api/v1/tasks/ws')
  
  return (
    <div className="task-queue-container">
      <TaskOverview stats={stats} />
      <TaskFilters onFiltersChange={handleFiltersChange} />
      <TaskList tasks={tasks} onTaskAction={handleTaskAction} />
      <TaskPagination />
    </div>
  )
}
```

**Task Overview Widget** (`components/tasks/TaskOverview.tsx`)
```tsx
interface TaskStats {
  active: number
  pending: number
  completed: number
  failed: number
  workerCapacity: { used: number; total: number }
  avgExecutionTime: number
  successRate: number
}

export function TaskOverview({ stats }: { stats: TaskStats }) {
  return (
    <div className="task-overview-grid">
      <StatCard title="Active Tasks" value={stats.active} color="blue" />
      <StatCard title="Pending" value={stats.pending} color="yellow" />
      <StatCard title="Completed Today" value={stats.completed} color="green" />
      <StatCard title="Failed" value={stats.failed} color="red" />
      <WorkerCapacityWidget capacity={stats.workerCapacity} />
      <PerformanceMetrics stats={stats} />
    </div>
  )
}
```

**Task List Component** (`components/tasks/TaskList.tsx`)
```tsx
interface Task {
  uid: string
  task_type: 'scan_disk' | 'calculate_md5' | 'scan_mediainfo' | 'move_files' | 'delete_files'
  execution_priority: 'immediate' | 'opportunistic' | 'scheduled'
  status: 'pending' | 'executing' | 'complete' | 'failed' | 'cancelled'
  description: string
  progress_percent: number
  files_processed: number
  bytes_processed: number
  created_on: number
  updated_on: number
  completed_on?: number
  error_message?: string
  estimated_duration?: number
}

export function TaskList({ tasks, onTaskAction }: TaskListProps) {
  const [selectedTasks, setSelectedTasks] = useState<string[]>([])
  
  return (
    <div className="task-list">
      <BulkActions selectedTasks={selectedTasks} onAction={onTaskAction} />
      <Table>
        <TaskTableHeader />
        {tasks.map(task => (
          <TaskRow 
            key={task.uid} 
            task={task} 
            isSelected={selectedTasks.includes(task.uid)}
            onSelect={handleTaskSelection}
            onAction={onTaskAction}
          />
        ))}
      </Table>
    </div>
  )
}
```

**Task Row Component** (`components/tasks/TaskRow.tsx`)
```tsx
export function TaskRow({ task, isSelected, onSelect, onAction }: TaskRowProps) {
  return (
    <TableRow className={`task-row ${task.status}`}>
      <TableCell>
        <Checkbox checked={isSelected} onChange={onSelect} />
      </TableCell>
      <TableCell>
        <TaskTypeIcon type={task.task_type} />
        <span>{task.task_type}</span>
      </TableCell>
      <TableCell>
        <TaskStatus status={task.status} />
      </TableCell>
      <TableCell>
        <TaskPriority priority={task.execution_priority} />
      </TableCell>
      <TableCell className="progress-cell">
        <ProgressBar 
          percentage={task.progress_percent}
          filesProcessed={task.files_processed}
          bytesProcessed={task.bytes_processed}
        />
      </TableCell>
      <TableCell>
        <TaskDuration 
          createdOn={task.created_on}
          completedOn={task.completed_on}
          estimatedDuration={task.estimated_duration}
        />
      </TableCell>
      <TableCell>
        <TaskActions 
          task={task} 
          onAction={onAction}
        />
      </TableCell>
    </TableRow>
  )
}
```

**Task Details Modal** (`components/tasks/TaskDetailsModal.tsx`)
```tsx
export function TaskDetailsModal({ task, isOpen, onClose }: TaskDetailsModalProps) {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="task-details-modal">
        <TaskHeader task={task} />
        <TabsContainer>
          <Tab title="Overview">
            <TaskOverviewTab task={task} />
          </Tab>
          <Tab title="Progress">
            <TaskProgressTab task={task} />
          </Tab>
          <Tab title="Files">
            <TaskFilesTab task={task} />
          </Tab>
          <Tab title="Logs">
            <TaskLogsTab task={task} />
          </Tab>
        </TabsContainer>
        <TaskDetailActions task={task} onAction={handleTaskAction} />
      </DialogContent>
    </Dialog>
  )
}
```

### State Management

**Task Queue Store** (`stores/taskQueueStore.ts`)
```typescript
interface TaskQueueState {
  tasks: Task[]
  stats: TaskStats
  filters: TaskFilters
  pagination: PaginationState
  selectedTasks: string[]
  isLoading: boolean
  error: string | null
}

interface TaskQueueActions {
  fetchTasks: () => Promise<void>
  fetchStats: () => Promise<void>
  updateFilters: (filters: Partial<TaskFilters>) => void
  selectTask: (taskId: string) => void
  selectAllTasks: () => void
  clearSelection: () => void
  cancelTask: (taskId: string) => Promise<void>
  retryTask: (taskId: string) => Promise<void>
  deleteTask: (taskId: string) => Promise<void>
  bulkCancel: (taskIds: string[]) => Promise<void>
  bulkDelete: (taskIds: string[]) => Promise<void>
}

export const useTaskQueueStore = create<TaskQueueState & TaskQueueActions>()
```

### WebSocket Integration

**Real-Time Updates Hook** (`hooks/useTaskWebSocket.ts`)
```typescript
export function useTaskWebSocket() {
  const { connect, disconnect, isConnected } = useWebSocket('/api/v1/tasks/ws')
  const updateTask = useTaskQueueStore(state => state.updateTask)
  
  useEffect(() => {
    connect({
      onMessage: (event) => {
        const update = JSON.parse(event.data)
        switch (update.type) {
          case 'task_updated':
            updateTask(update.task)
            break
          case 'task_created':
            addTask(update.task)
            break
          case 'task_completed':
            showNotification(`Task completed: ${update.task.description}`)
            break
        }
      }
    })
    
    return () => disconnect()
  }, [])
  
  return { isConnected }
}
```

### API Integration

**Task API Service** (`services/taskService.ts`)
```typescript
export class TaskService {
  async getTasks(filters: TaskFilters, pagination: PaginationState): Promise<TaskListResponse> {
    const params = new URLSearchParams({
      page: pagination.page.toString(),
      limit: pagination.limit.toString(),
      status: filters.status?.join(',') || '',
      type: filters.type?.join(',') || '',
      priority: filters.priority?.join(',') || '',
      search: filters.search || ''
    })
    
    return api.get(`/api/v1/tasks?${params}`)
  }
  
  async getTaskStats(): Promise<TaskStats> {
    return api.get('/api/v1/tasks/stats')
  }
  
  async cancelTask(taskId: string): Promise<void> {
    return api.put(`/api/v1/tasks/${taskId}/cancel`)
  }
  
  async retryTask(taskId: string): Promise<Task> {
    return api.post(`/api/v1/tasks/${taskId}/retry`)
  }
  
  async deleteTask(taskId: string): Promise<void> {
    return api.delete(`/api/v1/tasks/${taskId}`)
  }
  
  async bulkCancelTasks(taskIds: string[]): Promise<void> {
    return api.post('/api/v1/tasks/bulk/cancel', { task_ids: taskIds })
  }
}
```

### UI Components & Styling

**Progress Bar Component** (`components/ui/ProgressBar.tsx`)
```tsx
export function ProgressBar({ percentage, filesProcessed, bytesProcessed }: ProgressBarProps) {
  return (
    <div className="progress-container">
      <div className="progress-bar">
        <div 
          className="progress-fill"
          style={{ width: `${percentage}%` }}
        />
      </div>
      <div className="progress-details">
        <span>{percentage}%</span>
        <span>{filesProcessed} files</span>
        <span>{formatBytes(bytesProcessed)}</span>
      </div>
    </div>
  )
}
```

**Task Status Badge** (`components/tasks/TaskStatus.tsx`)
```tsx
export function TaskStatus({ status }: { status: Task['status'] }) {
  const statusConfig = {
    pending: { color: 'bg-yellow-100 text-yellow-800', label: 'Pending' },
    executing: { color: 'bg-blue-100 text-blue-800', label: 'Running' },
    complete: { color: 'bg-green-100 text-green-800', label: 'Complete' },
    failed: { color: 'bg-red-100 text-red-800', label: 'Failed' },
    cancelled: { color: 'bg-gray-100 text-gray-800', label: 'Cancelled' }
  }
  
  const config = statusConfig[status]
  return (
    <Badge className={config.color}>
      {config.label}
    </Badge>
  )
}
```

## Validation & Testing

### Component Tests
- [ ] Task list rendering with various task states
- [ ] Filter and search functionality
- [ ] Progress bar accuracy and animations
- [ ] Modal dialog interactions
- [ ] Bulk selection and operations

### Integration Tests
- [ ] WebSocket connection and real-time updates
- [ ] API service integration with backend
- [ ] State management and data flow
- [ ] Navigation and routing
- [ ] Error handling and recovery

### User Experience Tests
- [ ] Responsive design across screen sizes
- [ ] Accessibility compliance (keyboard navigation, screen readers)
- [ ] Performance with large task lists (1000+ tasks)
- [ ] Real-time update responsiveness
- [ ] Error state handling and user feedback

## Dependencies

**Required Stories:**
- Story 2.1: Task Engine Foundation (API endpoints, task lifecycle)
- Story 2.2: MD5 Background Processing (MD5 task types and data)
- Story 2.3: MediaInfo Background Processing (MediaInfo task types and data)

**Frontend Dependencies:**
- shadcn/ui components (Table, Dialog, Badge, Progress, etc.)
- Zustand for state management
- WebSocket connection capability
- React hooks for real-time updates

## Definition of Done

- [ ] Task queue overview displays real-time statistics and system health
- [ ] Task list shows all tasks with proper filtering, sorting, and pagination
- [ ] Individual task details modal provides comprehensive task information
- [ ] Real-time updates work via WebSocket connection with graceful fallback
- [ ] Task control actions (cancel, retry, delete) function correctly
- [ ] Bulk operations work for multiple selected tasks
- [ ] Progress visualization accurately reflects task execution state
- [ ] Error handling provides clear feedback for failed operations
- [ ] Responsive design works across desktop screen sizes
- [ ] Performance remains smooth with large numbers of tasks
- [ ] Integration with existing navigation and layout
- [ ] All accessibility requirements met

## Success Metrics

- **Usability:** Users can monitor and control tasks without confusion or errors
- **Performance:** UI remains responsive with 1000+ tasks, updates within 1 second
- **Reliability:** 100% accurate task status display, no missed real-time updates
- **Accessibility:** Full keyboard navigation, screen reader compatibility
- **Visual Design:** Consistent with MediaMogul design system and shadcn/ui patterns

## Next Stories

This story enables:
- **Story 2.5:** Opportunistic Task Execution Logic (UI for monitoring opportunistic behavior)
- **Story 2.6:** Advanced Task Scheduling (UI for scheduling and dependency management)
- **Epic 3 Stories:** Migration task monitoring and control interfaces

## PRD Requirements Fulfilled

- **FR10:** "The main dashboard shall display... a detailed view of the task queue, including the number of parallel tasks currently executing, the number of pending tasks, and the execution mode"
- **Task Management:** Complete user interface for monitoring and controlling background operations
- **Real-Time Updates:** Live progress tracking and status updates for better user experience


## File List

*To be populated during implementation*

## Dev Agent Record

### Implementation Notes
*To be populated during development*

### Completion Notes
*To be populated upon completion*

### Debug Log References
*To be populated if debugging required*

## QA Results

*To be populated during QA review*
