# Story 4.2: Sonarr & Radarr Integration

## Story Overview

**As a** MediaMogul user with existing Sonarr and Radarr installations  
**I want** to connect my *arr applications to enrich file metadata and improve organization  
**So that** I can see rich media information (series/season/episode details, movie metadata, quality profiles) directly in MediaMogul and better organize my media collection

## Context

With Story 4.1 providing the external services integration foundation, Story 4.2 implements specific clients for Sonarr and Radarr applications. This integration enhances MediaMogul's file browser with rich metadata from *arr applications, providing users with comprehensive media information and improved organization capabilities.

**Integration Value:**
- **Rich Metadata:** Episode names, air dates, ratings, genres from *arr applications
- **Quality Intelligence:** Quality profiles, encoding details, release group information  
- **Path Correlation:** Automatic mapping between MediaMogul paths and *arr library paths
- **Organization Enhancement:** Series/season structure, movie collections, watchlist status

## Acceptance Criteria

### Sonarr Integration
- [ ] **API Client Implementation:** Complete Sonarr v3 API client with authentication and error handling
- [ ] **Series Metadata Sync:** Import series information, episode details, quality profiles, and monitoring status
- [ ] **File Path Correlation:** Match MediaMogul files with Sonarr episode files using path mapping and metadata comparison
- [ ] **Episode Intelligence:** Display episode names, air dates, season/episode numbers, and series information in file browser
- [ ] **Quality Profile Integration:** Show quality settings, encoding preferences, and release group information
- [ ] **Sync Management:** Background synchronization with configurable intervals and manual refresh capabilities

### Radarr Integration  
- [ ] **API Client Implementation:** Complete Radarr v3 API client with authentication and error handling
- [ ] **Movie Metadata Sync:** Import movie information, quality profiles, collection details, and monitoring status
- [ ] **File Path Correlation:** Match MediaMogul files with Radarr movie files using path mapping and metadata comparison
- [ ] **Movie Intelligence:** Display movie titles, release years, ratings, genres, and collection information in file browser
- [ ] **Quality Profile Integration:** Show quality settings, encoding preferences, and release information
- [ ] **Collection Support:** Group related movies and display collection membership

### Path Mapping & Correlation
- [ ] **Intelligent Path Mapping:** Automatic detection and suggestion of path mappings between MediaMogul and *arr applications
- [ ] **Path Resolution Engine:** Convert between MediaMogul absolute paths and *arr relative paths accurately
- [ ] **Multiple Mapping Support:** Handle complex scenarios with multiple download directories and storage locations
- [ ] **Validation System:** Verify path mappings work correctly and alert users to configuration issues
- [ ] **Conflict Resolution:** Handle scenarios where multiple *arr files could match a single MediaMogul file

### User Interface Integration
- [ ] **Enhanced File Details:** Rich metadata display in file browser with *arr information prominently featured
- [ ] **Service Integration Status:** Visual indicators showing which files have been enriched with *arr metadata
- [ ] **Metadata Refresh Controls:** Manual and automatic refresh options for keeping *arr data synchronized
- [ ] **Configuration Management:** User-friendly setup and management of Sonarr/Radarr connections
- [ ] **Error Reporting:** Clear feedback when *arr services are unavailable or misconfigured

## Technical Implementation

### API Client Architecture

**Sonarr Client** (`internal/external/sonarr_client.go`)
```go
type SonarrClient struct {
    serviceRegistry *ExternalServiceRegistry
    httpClient      *http.Client
    circuitBreaker  *CircuitBreaker
    rateLimiter     *RateLimiter
}

type SonarrSeries struct {
    ID               int                 `json:"id"`
    Title            string             `json:"title"`
    SortTitle        string             `json:"sortTitle"`
    Status           string             `json:"status"`
    Overview         string             `json:"overview"`
    Network          string             `json:"network"`
    AirTime          string             `json:"airTime"`
    Images           []SonarrImage      `json:"images"`
    Seasons          []SonarrSeason     `json:"seasons"`
    Year             int                `json:"year"`
    Path             string             `json:"path"`
    QualityProfileID int                `json:"qualityProfileId"`
    LanguageProfileID int               `json:"languageProfileId"`
    SeriesType       string             `json:"seriesType"`
    Monitored        bool               `json:"monitored"`
    UseSceneNumbering bool              `json:"useSceneNumbering"`
    Runtime          int                `json:"runtime"`
    TvdbId           int                `json:"tvdbId"`
    TvRageId         int                `json:"tvRageId"`
    TvMazeId         int                `json:"tvMazeId"`
    FirstAired       time.Time          `json:"firstAired"`
    LastInfoSync     time.Time          `json:"lastInfoSync"`
    Genres           []string           `json:"genres"`
    Tags             []int              `json:"tags"`
    Added            time.Time          `json:"added"`
    Ratings          SonarrRatings      `json:"ratings"`
}

type SonarrEpisode struct {
    ID                      int           `json:"id"`
    SeriesID                int           `json:"seriesId"`
    EpisodeFileID           int           `json:"episodeFileId"`
    SeasonNumber            int           `json:"seasonNumber"`
    EpisodeNumber           int           `json:"episodeNumber"`
    Title                   string        `json:"title"`
    AirDate                 string        `json:"airDate"`
    AirDateUtc              time.Time     `json:"airDateUtc"`
    Overview                string        `json:"overview"`
    HasFile                 bool          `json:"hasFile"`
    Monitored               bool          `json:"monitored"`
    AbsoluteEpisodeNumber   int           `json:"absoluteEpisodeNumber"`
    SceneAbsoluteEpisodeNumber int        `json:"sceneAbsoluteEpisodeNumber"`
    SceneEpisodeNumber      int           `json:"sceneEpisodeNumber"`
    SceneSeasonNumber       int           `json:"sceneSeasonNumber"`
    UnverifiedSceneNumbering bool         `json:"unverifiedSceneNumbering"`
    EpisodeFile             *SonarrEpisodeFile `json:"episodeFile,omitempty"`
}
```

**Radarr Client** (`internal/external/radarr_client.go`)
```go
type RadarrClient struct {
    serviceRegistry *ExternalServiceRegistry
    httpClient      *http.Client
    circuitBreaker  *CircuitBreaker
    rateLimiter     *RateLimiter
}

type RadarrMovie struct {
    ID                    int               `json:"id"`
    Title                 string           `json:"title"`
    OriginalTitle         string           `json:"originalTitle"`
    AlternateTitles       []RadarrAlternateTitle `json:"alternateTitles"`
    SecondaryYearSourceId int              `json:"secondaryYearSourceId"`
    SortTitle             string           `json:"sortTitle"`
    SizeOnDisk            int64            `json:"sizeOnDisk"`
    Status                string           `json:"status"`
    Overview              string           `json:"overview"`
    InCinemas             time.Time        `json:"inCinemas"`
    Images                []RadarrImage    `json:"images"`
    Website               string           `json:"website"`
    Downloaded            bool             `json:"downloaded"`
    Year                  int              `json:"year"`
    HasFile               bool             `json:"hasFile"`
    YouTubeTrailerID      string           `json:"youTubeTrailerId"`
    Studio                string           `json:"studio"`
    Path                  string           `json:"path"`
    QualityProfileID      int              `json:"qualityProfileId"`
    Monitored             bool             `json:"monitored"`
    MinimumAvailability   string           `json:"minimumAvailability"`
    IsAvailable           bool             `json:"isAvailable"`
    FolderName            string           `json:"folderName"`
    Runtime               int              `json:"runtime"`
    CleanTitle            string           `json:"cleanTitle"`
    ImdbId                string           `json:"imdbId"`
    TmdbId                int              `json:"tmdbId"`
    TitleSlug             string           `json:"titleSlug"`
    Genres                []string         `json:"genres"`
    Tags                  []int            `json:"tags"`
    Added                 time.Time        `json:"added"`
    Ratings               RadarrRatings    `json:"ratings"`
    MovieFile             *RadarrMovieFile `json:"movieFile,omitempty"`
    Collection            *RadarrCollection `json:"collection,omitempty"`
}
```

### Path Correlation Engine

**Path Mapping Service** (`internal/services/path_mapping_service.go`)
```go
type PathMappingService struct {
    db                  *sql.DB
    externalServiceRepo *repositories.ExternalServiceRepository
    fileRepo            *repositories.FileRepository
}

type PathMapping struct {
    ID                    string `json:"id"`
    ExternalServiceID     string `json:"external_service_id"`
    MediaMogulPath        string `json:"mediamogul_path"`        // /mnt/media/tv/
    ExternalServicePath   string `json:"external_service_path"`  // /downloads/tv/
    MappingType           string `json:"mapping_type"`           // root, download, library
    Description           string `json:"description"`
    IsActive              bool   `json:"is_active"`
    ValidationStatus      string `json:"validation_status"`      // valid, invalid, unknown
    CreatedAt             time.Time `json:"created_at"`
    UpdatedAt             time.Time `json:"updated_at"`
}

// ResolvePathForService converts MediaMogul absolute path to external service path
func (pms *PathMappingService) ResolvePathForService(serviceID, mediamogulPath string) (string, error)

// ResolvePathFromService converts external service path to MediaMogul absolute path  
func (pms *PathMappingService) ResolvePathFromService(serviceID, servicePath string) (string, error)

// ValidatePathMapping tests if a path mapping works correctly
func (pms *PathMappingService) ValidatePathMapping(mapping *PathMapping) error

// SuggestPathMappings analyzes file paths to suggest automatic mappings
func (pms *PathMappingService) SuggestPathMappings(serviceID string) ([]PathMapping, error)
```

### Metadata Correlation Engine

**Metadata Correlation Service** (`internal/services/metadata_correlation_service.go`)
```go
type MetadataCorrelationService struct {
    db              *sql.DB
    sonarrClient    *SonarrClient
    radarrClient    *RadarrClient
    pathMapping     *PathMappingService
    fileRepo        *repositories.FileRepository
}

// CorrelateFile matches MediaMogul file with external service metadata
func (mcs *MetadataCorrelationService) CorrelateFile(fileID string, serviceID string) (*FileCorrelation, error)

// BulkCorrelateFiles processes multiple files for correlation
func (mcs *MetadataCorrelationService) BulkCorrelateFiles(serviceID string, fileIDs []string) ([]FileCorrelation, error)

type FileCorrelation struct {
    FileID              string                 `json:"file_id"`
    ServiceID           string                 `json:"service_id"`
    ExternalID          string                 `json:"external_id"`          // Series/Movie ID in external service
    ExternalFileID      string                 `json:"external_file_id"`     // Episode/Movie file ID
    CorrelationType     string                 `json:"correlation_type"`     // exact, fuzzy, manual
    MatchConfidence     float64               `json:"match_confidence"`      // 0.0 to 1.0
    MetadataEnrichment  map[string]interface{} `json:"metadata_enrichment"`
    PathMapping         *PathMapping          `json:"path_mapping"`
    LastCorrelated      time.Time             `json:"last_correlated"`
    CorrelationStatus   string                `json:"correlation_status"`    // pending, matched, failed, manual_review
}
```

## Database Schema

**Path Mapping Table** (`migrations/009_path_mappings.sql`)
```sql
CREATE TABLE external_service_path_mappings (
    id TEXT PRIMARY KEY,
    external_service_id TEXT NOT NULL REFERENCES external_services(id) ON DELETE CASCADE,
    mediamogul_path TEXT NOT NULL,
    external_service_path TEXT NOT NULL,
    mapping_type TEXT NOT NULL CHECK (mapping_type IN ('root', 'download', 'library')),
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    validation_status TEXT NOT NULL DEFAULT 'unknown' CHECK (validation_status IN ('valid', 'invalid', 'unknown')),
    validation_error TEXT,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    UNIQUE(external_service_id, mediamogul_path, external_service_path)
);

CREATE INDEX idx_path_mappings_service_id ON external_service_path_mappings(external_service_id);
CREATE INDEX idx_path_mappings_active ON external_service_path_mappings(is_active);
```

**File Correlation Table** (`migrations/010_file_correlations.sql`)
```sql
CREATE TABLE external_file_correlations (
    id TEXT PRIMARY KEY,
    file_id TEXT NOT NULL REFERENCES files(id) ON DELETE CASCADE,
    external_service_id TEXT NOT NULL REFERENCES external_services(id) ON DELETE CASCADE,
    external_id TEXT NOT NULL,              -- Series/Movie ID
    external_file_id TEXT,                  -- Episode/Movie file ID
    correlation_type TEXT NOT NULL CHECK (correlation_type IN ('exact', 'fuzzy', 'manual')),
    match_confidence REAL NOT NULL DEFAULT 0.0 CHECK (match_confidence >= 0.0 AND match_confidence <= 1.0),
    metadata_enrichment TEXT NOT NULL DEFAULT '{}', -- JSON metadata
    correlation_status TEXT NOT NULL DEFAULT 'pending' CHECK (correlation_status IN ('pending', 'matched', 'failed', 'manual_review')),
    last_correlated INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    UNIQUE(file_id, external_service_id)
);

CREATE INDEX idx_file_correlations_file_id ON external_file_correlations(file_id);
CREATE INDEX idx_file_correlations_service_id ON external_file_correlations(external_service_id);
CREATE INDEX idx_file_correlations_external_id ON external_file_correlations(external_id);
CREATE INDEX idx_file_correlations_status ON external_file_correlations(correlation_status);
```

## API Endpoints

### Sonarr & Radarr Integration Management
```
POST   /api/v1/external-services/{serviceId}/sync           # Full sync with external service
POST   /api/v1/external-services/{serviceId}/sync/series    # Sync series data (Sonarr only)
POST   /api/v1/external-services/{serviceId}/sync/movies    # Sync movie data (Radarr only)
GET    /api/v1/external-services/{serviceId}/library        # Get external service library
POST   /api/v1/external-services/{serviceId}/test-paths     # Test path mapping configuration
```

### Path Mapping Management
```
GET    /api/v1/path-mappings                                # List all path mappings
POST   /api/v1/path-mappings                                # Create path mapping
GET    /api/v1/path-mappings/{mappingId}                    # Get path mapping
PUT    /api/v1/path-mappings/{mappingId}                    # Update path mapping
DELETE /api/v1/path-mappings/{mappingId}                    # Delete path mapping
POST   /api/v1/path-mappings/{mappingId}/validate           # Validate path mapping
POST   /api/v1/path-mappings/suggest                        # Suggest automatic mappings
```

### File Metadata & Correlation
```
GET    /api/v1/files/{fileId}/external-metadata             # Get enriched metadata for file
POST   /api/v1/files/{fileId}/correlate                     # Manual correlation with external service
PUT    /api/v1/files/{fileId}/external-metadata             # Update external metadata
POST   /api/v1/files/bulk-correlate                         # Bulk correlation for multiple files
GET    /api/v1/correlations                                 # List file correlations with filtering
PUT    /api/v1/correlations/{correlationId}/approve         # Approve pending correlation
DELETE /api/v1/correlations/{correlationId}                 # Remove correlation
```

## Validation & Testing

### Integration Tests
- [ ] Sonarr API client functionality with mock and real instances
- [ ] Radarr API client functionality with mock and real instances
- [ ] Path mapping resolution accuracy and edge case handling
- [ ] File correlation engine with various file naming patterns
- [ ] Metadata synchronization and conflict resolution

### Performance Tests
- [ ] Large library synchronization performance (1000+ items)
- [ ] Path resolution performance under load
- [ ] Concurrent correlation processing efficiency
- [ ] Memory usage during bulk operations

### Edge Case Testing
- [ ] Network failure and service unavailability handling
- [ ] Malformed external service responses
- [ ] Complex path mapping scenarios (symbolic links, nested directories)
- [ ] Duplicate file detection and resolution
- [ ] Unicode and special character handling in paths and metadata

## Dependencies

**Required Infrastructure:**
- Story 4.1: External Services Integration Foundation (Complete)
- Epic 1: Database and core file management
- Epic 2: Task engine for background synchronization

**External Dependencies:**
- Sonarr v3 API access and authentication
- Radarr v3 API access and authentication
- Network connectivity to *arr services
- Compatible file organization between MediaMogul and *arr applications

## Definition of Done

- [ ] Complete Sonarr v3 API client with full series and episode support
- [ ] Complete Radarr v3 API client with full movie and collection support
- [ ] Intelligent path mapping system with automatic suggestion and validation
- [ ] Robust file correlation engine with high accuracy matching
- [ ] Rich metadata integration in file browser and details views
- [ ] Background synchronization with configurable intervals
- [ ] Comprehensive error handling and user feedback
- [ ] REST API for all integration management operations
- [ ] Frontend interface for *arr service setup and monitoring
- [ ] Database schema supporting all correlation and mapping data

## Success Metrics

- **Metadata Coverage:** 85%+ of compatible media files successfully correlated with *arr metadata
- **Correlation Accuracy:** 95%+ accurate file-to-metadata matching with <5% false positives
- **Sync Performance:** <30 seconds for typical library synchronization (500-1000 items)
- **User Adoption:** 70%+ of users with *arr setups successfully configuring integration
- **Path Mapping Success:** 90%+ automatic path mapping suggestions work without manual adjustment

## Next Stories

This story enables:
- **Story 4.3:** Advanced File Deletion - Enhanced deletion with *arr integration awareness
- **Future Enhancement:** Additional *arr service support (Lidarr, Readarr, etc.)
- **Future Enhancement:** Advanced metadata filtering and organization based on *arr data

## PRD Requirements Fulfilled

- **FR9:** Complete Sonarr and Radarr API integration for metadata enrichment
- **Enhanced User Experience:** Rich media information display improving file organization
- **Extensible Framework:** Foundation for additional external service integrations


## File List

*To be populated during implementation*

## Dev Agent Record

### Implementation Notes
*To be populated during development*

### Completion Notes
*To be populated upon completion*

### Debug Log References
*To be populated if debugging required*

## QA Results

*To be populated during QA review*
