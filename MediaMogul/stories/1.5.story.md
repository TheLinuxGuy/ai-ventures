# Story: File Browser Interface

## Status: Approved

## Story

As a user,
I want to browse my files and folders through a web interface,
so that I can explore my media library without needing direct disk access.

## Acceptance Criteria

### File Browser Navigation
- [ ] Hierarchical file browser starting from disk roots
- [ ] Folder navigation with breadcrumb trail
- [ ] File and folder listing with metadata (size, date modified with full timestamp precision)
- [ ] Folder size calculation (total size of contents)
- [ ] Search functionality for files and folders
- [ ] Sorting options (name, size, date, type)
- [ ] Performance optimization for large directories
- [ ] Keyboard navigation support

### Visual Usage Indicators
- [ ] Folder size bars showing relative usage within parent directory
- [ ] Color-coded usage indicators (green < 50%, yellow 50-80%, red > 80%)
- [ ] Percentage display showing folder's share of parent total
- [ ] Visual usage bars positioned behind folder names for clear association
- [ ] Disk root level usage showing percentage of total disk capacity
- [ ] Consistent color scheme across all usage visualizations

### Storage Unit Display Requirements
- [ ] Human-readable storage units as default display (auto-scale: bytes → KB → MB → GB → TB)
- [ ] Intelligent unit selection (1.7 GB preferred over 1,700 MB, 700.12 MB over 700,120,000 bytes)
- [ ] Consistent decimal precision (2 decimal places for values < 10, 1 decimal for 10-99, whole numbers for 100+)
- [ ] User preference toggle for storage unit display format
- [ ] Info button ("i") next to sizes allowing unit conversion view
- [ ] Expandable tooltip showing multiple unit representations (bytes, KB, MB, GB, TB)
- [ ] Consistent formatting across all file sizes, folder sizes, and disk capacity displays

### Timestamp Display Requirements
- [ ] All timestamps displayed with full precision (date, hour, minute, second)
- [ ] Timestamps automatically converted to user's browser timezone
- [ ] Consistent timestamp formatting across all file/folder displays
- [ ] Proper handling of timezone conversion for sorting operations

## Dev Notes

### Previous Story Insights
**From Story 1.1 - Application Bootstrap and Configuration:**
- PhysicalDisk model with user aliases for friendly disk names
- Configuration system for monitored paths

**From Story 1.2 - Physical Disk Discovery and Registration:**
- Disk metadata with device paths and mount points
- Power status integration for disk access decisions

**From Story 1.3 - File System Scanning Engine:**
- Complete File and Folder models with hierarchy relationships
- Database contains full file inventory with metadata
- Relative path structure for efficient navigation
- UTC timestamp storage for all file modification times

**From Story 1.4 - System Dashboard:**
- Real-time data patterns and performance optimization techniques
- WebSocket infrastructure for live updates

### Data Models
**File Browser View Models** [Derived from Story 1.3 models]
- Uses existing File and Folder models from scanning engine
- No new database tables required - optimized queries on existing schema
- Folder size calculation from aggregated file sizes
- Virtual root navigation combining all monitored disk roots

**Visual Usage Model** [Enhanced for user experience]
- Parent-relative usage calculation: folder_size / parent_total_size * 100
- Disk-level usage calculation: used_space / total_disk_capacity * 100
- Color thresholds: Green (0-49%), Yellow (50-79%), Red (80-100%)
- Usage bar rendering: CSS width percentage with background color coding
- Real-time usage updates when folder sizes change

**Storage Unit Display Model** [Human-readable formatting]
- Automatic unit scaling: bytes → KB → MB → GB → TB based on size magnitude
- Intelligent thresholds: Use higher unit when result is ≥ 1000 (e.g., 1.5 GB vs 1,500 MB)
- Precision rules: 2 decimals for < 10, 1 decimal for 10-99, whole numbers for ≥ 100
- Multiple unit representations: Store bytes, display preferred unit, show all in tooltip
- User preference storage: LocalStorage/cookie for unit display preference
- Consistent formatting: Same logic applied to file sizes, folder sizes, disk capacity

**Timestamp Handling Model** [Enhanced from Story 1.3]
- All timestamps stored as UTC in ISO 8601 format in database
- Browser-side timezone conversion using JavaScript Intl API
- Environment variable `TZ=America/New_York` as server-side fallback
- Full precision timestamps (YYYY-MM-DD HH:MM:SS) for all displays

**Search Index Model** [Source: Epic 1 Technical Tasks]
- Purpose: Optimized search functionality across all files and folders
- Implementation: Database indexes on file/folder names and paths
- Search queries use LIKE patterns with proper indexing

### API Specifications
**File Browser API Endpoints** [Source: Epic 1 Technical Tasks]
- GET /api/v1/browse/roots - Get all disk roots for navigation with usage statistics
- GET /api/v1/browse/folder/{id} - Get folder contents with metadata and relative usage percentages
- GET /api/v1/browse/path/{path} - Navigate to specific path
- GET /api/v1/browse/search?query={term} - Search files and folders
- GET /api/v1/browse/folder/{id}/size - Get calculated folder size with parent percentage
- GET /api/v1/browse/disk/{id}/usage - Get disk capacity and usage statistics
- Support for sorting and pagination parameters
- All timestamp responses in ISO 8601 UTC format for frontend conversion
- Usage percentages calculated server-side for consistency

### Component Specifications
**File Browser UI Components** [Source: Epic 1 Technical Tasks]
- Hierarchical tree navigation or breadcrumb navigation
- File and folder grid/list view with configurable layouts
- Visual usage bars integrated behind folder names with color coding
- Usage percentage display alongside folder sizes
- Human-readable storage unit display with consistent formatting
- Info buttons ("i") next to sizes for unit conversion tooltips
- Storage unit preference controls in user settings
- Search interface with real-time results
- Sorting controls (name, size, date, type, usage percentage)
- Keyboard navigation support (arrow keys, enter, escape)
- Loading states and infinite scroll for large directories
- Full-precision timestamp display with browser timezone conversion
- Color-coded usage indicators (green/yellow/red) with accessibility support
- React components with Tailwind CSS styling [Source: architecture.md#Tech Stack]

### File Locations
**Backend Structure** [Source: architecture.md#Unified Project Structure]
- File browser service: `apps/backend/internal/service/browser.go`
- Search service: `apps/backend/internal/service/search.go`
- Folder size calculation: `apps/backend/internal/service/foldersize.go`
- Browser API endpoints: `apps/backend/internal/api/browse.go`

**Frontend Structure** [Source: architecture.md#Unified Project Structure]
- File browser page: `apps/frontend/app/browse/page.tsx`
- Browser components: `apps/frontend/components/browser/`
- Usage visualization components: `apps/frontend/components/usage/`
- Storage unit display components: `apps/frontend/components/storage/`
- Navigation hooks: `apps/frontend/hooks/useBrowser.ts`
- Search components: `apps/frontend/components/search/`
- Timestamp utilities: `apps/frontend/utils/timezone.ts`
- Usage calculation utilities: `apps/frontend/utils/usage.ts`
- Storage formatting utilities: `apps/frontend/utils/storage.ts`
- User preferences hooks: `apps/frontend/hooks/useUserPreferences.ts`
- Shared types: `packages/shared-types/browser.ts`

### Technical Constraints
**Performance**: Navigation < 1 second per folder [Source: Epic 1 Success Criteria]
**Large Directories**: Handle 1000+ items per directory [Source: Epic 1 AC7]
**Database Queries**: Efficient pagination and indexing for performance
**Power Management**: Database-only browsing without disk access [Source: architecture.md NFR1]
**Memory Usage**: Efficient rendering of large file lists with usage visualizations
**Timestamp Storage**: All timestamps stored as UTC in database, converted client-side
**Timezone Handling**: Browser timezone detection with TZ environment variable fallback
**Usage Calculations**: Server-side percentage calculations to reduce client load
**Accessibility**: Color-blind friendly usage indicators with text labels and patterns
**Storage Unit Consistency**: All size displays use same formatting logic for consistency
**User Preferences**: Storage unit preferences persist across browser sessions
**Performance**: Storage unit formatting optimized to avoid expensive calculations

### Testing Requirements
**Backend Testing**: Unit tests for browser service, search, and folder size calculation [Source: architecture.md#Tech Stack]
**Frontend Testing**: Component tests for all browser UI components and keyboard navigation
**Performance Testing**: Large directory handling and search performance
**Integration Testing**: Complete browsing workflows and search functionality

## Tasks / Subtasks

### Backend Implementation - File Browser Service
- [ ] Create file browser service for navigation (AC: 1, 2)
  - [ ] Implement disk root enumeration from monitored paths
  - [ ] Add folder hierarchy navigation using existing Folder model
- [ ] Add breadcrumb trail generation (AC: 2)
  - [ ] Generate parent folder chain from database relationships
  - [ ] Support both ID-based and path-based navigation
- [ ] Implement file and folder listing with metadata (AC: 3, 9)
  - [ ] Query files and folders with size, modification time
  - [ ] Ensure all timestamps returned in ISO 8601 UTC format
  - [ ] Add pagination support for large directories
- [ ] Add folder size calculation service (AC: 4)
  - [ ] Aggregate file sizes for folder total calculation
  - [ ] Calculate relative usage percentages within parent folders
  - [ ] Implement caching for expensive folder size operations
  - [ ] Add disk capacity queries for root-level usage calculations
- [ ] Write unit tests for all browser navigation and data retrieval

### Backend Implementation - Search and Sorting
- [ ] Implement search functionality (AC: 5)
  - [ ] Add database indexes on file and folder names
  - [ ] Support partial name matching with LIKE queries
  - [ ] Add search across all monitored disks and paths
- [ ] Add sorting capabilities (AC: 6, 12)
  - [ ] Support sorting by name, size, date modified, type
  - [ ] Implement efficient database ordering with indexes
  - [ ] Handle timezone-aware date sorting on UTC timestamps
- [ ] Add performance optimization for large directories (AC: 7)
  - [ ] Implement pagination with configurable page sizes
  - [ ] Add query optimization for common browse operations
- [ ] Write unit tests for search and sorting functionality

### Backend Implementation - Browser API Endpoints
- [ ] Create GET /api/v1/browse/roots endpoint
  - [ ] Return all monitored disk roots with metadata and usage statistics
  - [ ] Include disk aliases, availability status, and capacity information
- [ ] Create GET /api/v1/browse/folder/{id} endpoint
  - [ ] Return folder contents with file and subfolder listings
  - [ ] Include relative usage percentages for all folders
  - [ ] Support sorting and pagination parameters
  - [ ] Return all timestamps in ISO 8601 UTC format
- [ ] Create GET /api/v1/browse/search endpoint
  - [ ] Support query parameter with search terms
  - [ ] Return matching files and folders across all disks with usage data
- [ ] Create GET /api/v1/browse/folder/{id}/size endpoint for folder sizes
- [ ] Create GET /api/v1/browse/disk/{id}/usage endpoint for disk capacity and usage
- [ ] Add proper error handling and performance optimization
- [ ] Write unit tests for all browser API endpoints with usage calculations

### Frontend Implementation - Navigation Components
- [ ] Create disk root navigation component (AC: 1)
  - [ ] Display all monitored disks as navigation entry points
  - [ ] Show disk aliases and availability status
- [ ] Implement hierarchical folder navigation (AC: 1, 2)
  - [ ] Tree view or breadcrumb navigation
  - [ ] Support both click and keyboard navigation
- [ ] Create breadcrumb trail component (AC: 2)
  - [ ] Show current location in folder hierarchy
  - [ ] Support clicking breadcrumb segments for navigation
- [ ] Add keyboard navigation support (AC: 8)
  - [ ] Arrow key navigation through file/folder lists
  - [ ] Enter key for folder entry, escape for parent navigation
- [ ] Write component tests for all navigation features

### Frontend Implementation - File and Folder Display
- [ ] Create file and folder listing components (AC: 3, 9)
  - [ ] Grid and list view options for different preferences
  - [ ] Display file metadata (size, date modified, type)
  - [ ] Implement full-precision timestamp display (YYYY-MM-DD HH:MM:SS)
- [ ] Implement visual usage indicators (AC: 9, 10, 11, 12, 13, 14)
  - [ ] Create usage bar components positioned behind folder names
  - [ ] Implement color-coded indicators (green < 50%, yellow 50-80%, red > 80%)
  - [ ] Add percentage text display alongside usage bars
  - [ ] Ensure accessibility with color-blind friendly patterns and text labels
- [ ] Implement storage unit display components (AC: 15, 16, 17, 18, 19, 20, 21)
  - [ ] Create human-readable storage formatting utility functions
  - [ ] Implement automatic unit scaling (bytes → KB → MB → GB → TB)
  - [ ] Add intelligent precision rules (2 decimals < 10, 1 decimal 10-99, whole ≥ 100)
  - [ ] Create info button ("i") components with unit conversion tooltips
  - [ ] Implement user preference storage and retrieval for unit display
  - [ ] Ensure consistent formatting across all size displays
- [ ] Implement timezone conversion utilities (AC: 22, 23, 24)
  - [ ] Create timezone utility functions for UTC to local conversion
  - [ ] Use browser's Intl.DateTimeFormat for automatic timezone detection
  - [ ] Add fallback to TZ environment variable for server-side operations
- [ ] Implement folder size display (AC: 4)
  - [ ] Show calculated folder sizes with human-readable formatting
  - [ ] Add loading states for folder size calculations
  - [ ] Include info buttons for unit conversion tooltips
- [ ] Add sorting controls (AC: 6, 25)
  - [ ] Dropdown or button controls for sort options
  - [ ] Support ascending/descending sort directions
  - [ ] Include usage percentage as sortable option
  - [ ] Handle timezone-aware date sorting in frontend
- [ ] Create search interface (AC: 5)
  - [ ] Search input with real-time results
  - [ ] Search result highlighting and navigation
- [ ] Add performance optimization for large directories (AC: 7)
  - [ ] Virtual scrolling or pagination for 1000+ items
  - [ ] Efficient rendering and state management
- [ ] Style all components with Tailwind CSS

### Integration & Quality
- [ ] Test complete file browser navigation workflows
- [ ] Verify search functionality across all monitored disks
- [ ] Test sorting and filtering with large directories including usage percentage sorting
- [ ] Validate keyboard navigation accessibility
- [ ] Test performance with directories containing 1000+ items including usage calculations
- [ ] Verify folder size calculations and usage percentages are accurate and performant
- [ ] Test visual usage indicators with various folder size distributions
- [ ] Validate color-coded usage displays for accessibility (color-blind testing)
- [ ] Test storage unit formatting with various file sizes (bytes to TB range)
- [ ] Verify human-readable unit selection logic (1.7 GB vs 1,700 MB preference)
- [ ] Test info button tooltips showing multiple unit representations
- [ ] Validate storage unit precision rules across different size ranges
- [ ] Test user preference persistence for storage unit display
- [ ] Verify consistent storage formatting across all components (files, folders, disks)
- [ ] Test error scenarios (missing folders, disk unavailable)
- [ ] Validate breadcrumb navigation and path handling
- [ ] Test timestamp display accuracy in various browser timezones
- [ ] Verify timezone conversion consistency across all file displays
- [ ] Test date sorting with timezone-aware comparisons
- [ ] Validate full-precision timestamp formatting (YYYY-MM-DD HH:MM:SS)
- [ ] Test usage bar rendering performance with large folder lists
- [ ] Verify usage percentage accuracy across different parent folder contexts
- [ ] Test storage unit conversion performance with large directory listings
- [ ] Validate tooltip performance when hovering over multiple info buttons

## Definition of Done

- Users can navigate entire file hierarchy via web interface starting from disk roots
- Folder sizes calculated and displayed accurately with reasonable performance
- Visual usage indicators show relative folder sizes with color-coded bars and percentages
- Usage percentages accurately reflect folder size relative to parent directory
- Color-coded indicators provide immediate visual feedback (green/yellow/red thresholds)
- All storage sizes display in human-readable format with intelligent unit selection
- Storage unit precision follows consistent rules (2 decimals < 10, 1 decimal 10-99, whole ≥ 100)
- Info buttons ("i") provide unit conversion tooltips showing bytes, KB, MB, GB, TB
- User storage unit preferences persist across browser sessions
- Consistent storage formatting across all file sizes, folder sizes, and disk capacity displays
- Search finds files and folders across all monitored disks with fast results
- Performance acceptable for directories with 1000+ items (< 1 second navigation)
- Keyboard navigation works smoothly for accessibility
- Sorting options work correctly for all metadata fields including usage percentage
- Breadcrumb navigation provides clear location context
- All timestamps display with full precision (YYYY-MM-DD HH:MM:SS format)
- Timestamps automatically converted to user's browser timezone
- Timezone conversion works consistently across all file and folder displays
- Visual usage indicators are accessible to color-blind users with text labels
- Storage unit tooltips provide power users access to exact byte values and all unit conversions
- All tests pass (unit, integration, component, performance, timezone, accessibility, storage formatting)
- No critical bugs or crashes during browsing operations

## File List

*To be populated during implementation*

## Dev Agent Record

### Implementation Notes
*To be populated during development*

### Completion Notes
*To be populated upon completion*

### Debug Log References
*To be populated if debugging required*

## QA Results

*To be populated during QA review*
